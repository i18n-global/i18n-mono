# t-wrapper 개선 방향성 (AS-IS → TO-BE)

## AS-IS

- 파일 단위 직렬 처리: 읽기 → 파싱(Babel) → traverse 변환 → 코드 생성/쓰기
- 단일 프로세스/싱글 스레드 중심
- 파일 간 컨텍스트 고려 낮음(공유 상수, import 그래프 등은 최소)
- SWC는 실험 상태(호환 계층 비용으로 실이득 낮음)
- 콘솔 출력 최소화(에러 중심), 리포트는 별도
- 상수/규칙은 `scripts/t-wrapper/constants.ts`로 중앙화됨

## TO-BE

1. 병렬 처리
   - Rust(t-wrapper-rust): Rayon 기반 `par_iter`로 파일 병렬 처리
   - 파이프라인화(read → parse/transform → write), bounded 채널로 백프레셔
2. 파서/성능
   - SWC 파서 본격 적용(필요 노드만 Babel 호환 변환)
   - 메모리 재사용(버퍼 풀, Arena 고려), I/O 배치 최적화
3. 2-pass 설계(선택)
   - Pass1: 메타 수집(컴포넌트/서버컴포넌트/공유상수)
   - Pass2: 정책 반영 변환(정확도 ↑, 불필요 변환 ↓)
4. 컨텍스트 확장
   - 파일 간 참조/그래프 분석(공유 상수, 외부 import 영향)
   - 변경 감지 캐시(mtime+크기+해시)로 재처리 최소화
5. 개발 DX
   - 에러/결과 리포트 구조화(JSON/파일 출력 옵션)
   - 상세 로그는 플래그 기반으로만 출력

## 단계적 로드맵

- Step 1: Rust에서 파일 병렬 처리 적용(안전한 동시성, per-file 에러 격리)
- Step 2: 파이프라인화 및 bounded 채널 도입(메모리 안정성)
- Step 3: SWC 파서 정착(필요 노드만 변환 → Babel traverse 최소화/제거)
- Step 4: 2-pass 및 컨텍스트 분석 도입(정확도/성능 동시 개선)
- Step 5: 리포트/옵션 정리(자동화/CI 친화적 출력 형식)

## 기대 효과

- 파일 수에 선형 확장 가능한 처리량(코어 수 활용 극대화)
- 파싱/변환 비용 절감(SWC + 변환 최소화)
- 불필요 작업 감소(변경 감지/2-pass 스킵)
- 운영/배포 친화적 리포팅 및 안정성 향상

## 처리 시퀀스 (조건 포함, 현재 기준)

1. 입력 준비
   - glob으로 대상 파일 수집 (예: `src/**/*.{js,jsx,ts,tsx}`)
   - 옵션 해석: `--pattern`, `--dry-run`, 환경변수 등

2. 파일 단위 루프 (현재는 직렬, TO-BE 병렬)
   - 2.1 파일 읽기 (문자열 소스)
   - 2.2 Parse
     - Babel 파서로 AST(`t.File`) 생성
     - 실패 시: 에러만 로그(최소 출력), 다음 파일로 진행
   - 2.3 서버 컴포넌트 감지
     - RSC로 판단되면 `useTranslation` 훅 삽입/바인딩 스킵
   - 2.4 import 관리
     - 이미 `useTranslation` import가 있으면 추가 안 함
     - 없고 서버 컴포넌트가 아니며, 변환 결과로 `t` 사용이 필요하면 import 추가
   - 2.5 t 바인딩 보장
     - 파일 상단(기존 import 블록 뒤)에 `const { t } = useTranslation();` 삽입
     - 이미 동일/동등 바인딩 존재 시 추가 안 함
     - 변수명 충돌 시: 기존 바인딩 재사용, 불필요 추가 스킵
   - 2.6 Traverse (변환)
     - 공통 스킵 조건
       - `i18n-ignore` 주석이 현재/상위 노드에 존재 시 스킵
       - 이미 `t("...")`로 감싼 문자열은 스킵
       - 빈 문자열/공백만 있는 문자열은 스킵
     - StringLiteral
       - 한국어 포함(`/[가-힣]/`)이면 `t("원문")`으로 교체
       - JSX Attribute 내 문자열은 `{t("원문")}`로 감싸기
     - TemplateLiteral
       - 정적/보간 혼합 문자열을 `t("문자 {{식}}", { 식 })` 형태로 변환
       - 보간식 식별자/멤버표현만 객체 인자로 전달 (과도한 코드 생성 지양)
     - JSXText
       - 한국어 포함 텍스트 → `{t("원문")}`
   - 2.7 Generate
     - 변환된 AST → 코드(문자열) 생성
   - 2.8 Write
     - `--dry-run`이면 파일 쓰기 생략, 미리보기/카운팅만
     - 실제 모드면 덮어쓰기
   - 2.9 리포트/로깅
     - 에러만 콘솔 출력(최소화 정책)
     - 성능/요약은 별도 리포터에서 처리 가능

3. 종료
   - 전체 성공/실패 개요 집계
   - 옵션에 따라 요약 출력/보고

주의
- 파일 간 컨텍스트는 현재 최소. 공유 상수/그래프 분석은 TO-BE에서 단계적 도입
- SWC는 실험: 필요 노드만 변환하는 얇은 호환층이 있을 때 채택
